import { Button, VerticalBox, HorizontalBox, ListView, ScrollView, LineEdit, StandardButton } from "std-widgets.slint";

// ========== Data Structures ==========
export struct NotifyItem {
    id: int,
    title: string,
    notify: string,
    device: string,
    received_at: string,
}

export struct TokenItem {
    id: int,
    token_hash: string,
    usage: string,
    created_at: string,
}

export struct StatData {
    today_count: int,
    total_count: int,
    device_count: int,
    is_running: bool,
}

// ========== Page Enum ==========
export enum Page {
    Dashboard,
    Notifications,
    Tokens,
    Settings
}

// ========== Nav Item Component ==========
component NavItem inherits Rectangle {
    in property <string> text;
    in property <bool> selected;
    callback clicked;

    height: 44px;
    background: selected ? #FFE6D1 : transparent;
    border-radius: 6px;
    border-width: 1px;
    border-color: selected ? #FFD2B0 : transparent;

    HorizontalBox {
        padding-left: 16px;
        padding-right: 16px;

        Text {
            text: root.text;
            color: selected ? #FF7A00 : #374151;
            font-size: 15px;
            vertical-alignment: center;
            font-weight: selected ? 600 : 400;
        }
    }

    touch-area := TouchArea {
        clicked => { root.clicked(); }
        mouse-cursor: pointer;
    }

    states [
        hover when touch-area.has-hover && !selected: {
            background: #FFF1E6;
        }
    ]
}

// ========== Stat Card Component ==========
component StatCard inherits Rectangle {
    in property <string> title;
    in property <string> value;
    in property <color> accent-color: #FF7A00;

    background: #FFFFFF;
    border-radius: 8px;
    border-width: 1px;
    border-color: #E6E8EC;
    min-width: 180px;
    min-height: 100px;

    VerticalBox {
        padding: 16px;
        spacing: 8px;

        Text {
            text: root.title;
            color: #6B7280;
            font-size: 14px;
        }

        Text {
            text: root.value;
            color: root.accent-color;
            font-size: 32px;
            font-weight: 700;
        }
    }
}

// ========== Notification Card Component ==========
component NotifyCard inherits Rectangle {
    in property <string> title;
    in property <string> notify;
    in property <string> device;
    in property <string> received-at;

    background: #FFFFFF;
    border-radius: 6px;
    border-width: 1px;
    border-color: #E6E8EC;
    min-height: 80px;

    VerticalBox {
        padding: 12px;
        spacing: 6px;

        HorizontalBox {
            spacing: 8px;

            Text {
                text: root.title;
                color: #111827;
                font-size: 15px;
                font-weight: 600;
                horizontal-stretch: 1;
            }

            Rectangle {
                background: #FF7A00;
                border-radius: 4px;
                width: self.preferred-width + 12px;
                height: 20px;

                Text {
                    text: root.device;
                    color: #FFFFFF;
                    font-size: 11px;
                    vertical-alignment: center;
                    horizontal-alignment: center;
                }
            }
        }

        Text {
            text: root.notify;
            color: #374151;
            font-size: 13px;
            wrap: word-wrap;
        }

        Text {
            text: root.received-at;
            color: #9CA3AF;
            font-size: 11px;
        }
    }
}

// ========== Token Card Component ==========
component TokenCard inherits Rectangle {
    in property <string> token-hash;
    in property <string> usage;
    in property <string> created-at;
    callback delete-clicked;

    background: #FFFFFF;
    border-radius: 6px;
    border-width: 1px;
    border-color: #E6E8EC;
    min-height: 70px;

    HorizontalBox {
        padding: 12px;
        spacing: 12px;

        VerticalBox {
            spacing: 4px;
            horizontal-stretch: 1;

            Text {
                text: root.usage;
                color: #111827;
                font-size: 14px;
                font-weight: 600;
            }

            Text {
                text: "Token: " + root.token-hash;
                color: #6B7280;
                font-size: 12px;
            }

            Text {
                text: "Created: " + root.created-at;
                color: #9CA3AF;
                font-size: 11px;
            }
        }

        Button {
            text: "Delete";
            clicked => { root.delete-clicked(); }
        }
    }
}

// ========== Dashboard Page ==========
component DashboardPage inherits Rectangle {
    in property <StatData> stats;
    in property <[NotifyItem]> recent-notifies;

    background: #F6F7FB;

    VerticalBox {
        padding: 24px;
        spacing: 24px;

        Text {
            text: "Dashboard";
            color: #111827;
            font-size: 24px;
            font-weight: 700;
        }

        // Stat Cards
        HorizontalBox {
            spacing: 16px;

            StatCard {
                title: "Today";
                value: stats.today-count;
                accent-color: #FF7A00;
            }

            StatCard {
                title: "Total";
                value: stats.total-count;
                accent-color: #16A34A;
            }

            StatCard {
                title: "Active Devices";
                value: stats.device-count;
                accent-color: #F59E0B;
            }

            StatCard {
                title: "Service Status";
                value: stats.is-running ? "Running" : "Stopped";
                accent-color: stats.is-running ? #16A34A : #DC2626;
            }
        }

        // Live Notifications
        VerticalBox {
            spacing: 12px;

            Text {
                text: "Live Notifications";
                color: #111827;
                font-size: 18px;
                font-weight: 600;
            }

            ScrollView {
                min-height: 240px;
                horizontal-stretch: 1;
                vertical-stretch: 1;

                VerticalBox {
                    spacing: 8px;

                    for notify in recent-notifies: NotifyCard {
                        title: notify.title;
                        notify: notify.notify;
                        device: notify.device;
                        received-at: notify.received-at;
                    }
                }
            }
        }
    }
}

// ========== Notifications Page ==========
component NotificationsPage inherits Rectangle {
    in property <[NotifyItem]> notifies;
    in-out property <string> search-text;
    callback search-changed(string);
    callback refresh-clicked;

    background: #F6F7FB;

    VerticalBox {
        padding: 24px;
        spacing: 16px;

        HorizontalBox {
            spacing: 16px;

            Text {
                text: "Notifications";
                color: #111827;
                font-size: 24px;
                font-weight: 700;
                horizontal-stretch: 1;
            }

            Button {
                text: "Refresh";
                clicked => { root.refresh-clicked(); }
            }
        }

        // Search Bar
        HorizontalBox {
            spacing: 8px;

            LineEdit {
                placeholder-text: "Search notifications...";
                text <=> root.search-text;
                edited => { root.search-changed(self.text); }
                horizontal-stretch: 1;
            }
        }

        // Notification List
        ScrollView {
            horizontal-stretch: 1;
            vertical-stretch: 1;

            VerticalBox {
                spacing: 8px;

                for notify in notifies: NotifyCard {
                    title: notify.title;
                    notify: notify.notify;
                    device: notify.device;
                    received-at: notify.received-at;
                }
            }
        }
    }
}

// ========== Tokens Page (Placeholder) ==========
component TokensPage inherits Rectangle {
    in property <[TokenItem]> tokens;
    in-out property <string> new-token-usage;
    callback create-token(string);
    callback delete-token(int);

    background: #F6F7FB;

    VerticalBox {
        padding: 24px;
        spacing: 16px;

        Text {
            text: "Tokens";
            color: #111827;
            font-size: 24px;
            font-weight: 700;
        }

        Rectangle {
            background: #FFFFFF;
            border-radius: 8px;
            border-width: 1px;
            border-color: #E6E8EC;
            min-height: 160px;
            horizontal-stretch: 1;
            vertical-stretch: 1;

            VerticalBox {
                padding: 20px;
                spacing: 8px;

                Text {
                    text: "Planned Feature";
                    color: #111827;
                    font-size: 16px;
                    font-weight: 600;
                }

                Text {
                    text: "This module will manage push tokens, including creation, revocation, and usage descriptions.";
                    color: #6B7280;
                    font-size: 13px;
                    wrap: word-wrap;
                }
            }
        }
    }
}

// ========== Settings Page ==========
component SettingsPage inherits Rectangle {
    in property <string> service-addr;
    in property <string> db-path;
    in property <bool> ws-connected;

    background: #F6F7FB;

    VerticalBox {
        padding: 24px;
        spacing: 16px;

        Text {
            text: "Settings";
            color: #111827;
            font-size: 24px;
            font-weight: 700;
        }

        // Service Configuration
        Rectangle {
            background: #FFFFFF;
            border-radius: 8px;
            border-width: 1px;
            border-color: #E6E8EC;
            min-height: 150px;

            VerticalBox {
                padding: 16px;
                spacing: 12px;

                Text {
                    text: "Service Configuration";
                    color: #111827;
                    font-size: 16px;
                    font-weight: 600;
                }

                HorizontalBox {
                    spacing: 8px;

                    Text {
                        text: "Service URL:";
                        color: #6B7280;
                        font-size: 14px;
                        width: 110px;
                    }

                    Text {
                        text: root.service-addr;
                        color: #FF7A00;
                        font-size: 14px;
                    }
                }

                HorizontalBox {
                    spacing: 8px;

                    Text {
                        text: "Database Path:";
                        color: #6B7280;
                        font-size: 14px;
                        width: 110px;
                    }

                    Text {
                        text: root.db-path;
                        color: #FF7A00;
                        font-size: 14px;
                    }
                }

                HorizontalBox {
                    spacing: 8px;

                    Text {
                        text: "WebSocket:";
                        color: #6B7280;
                        font-size: 14px;
                        width: 110px;
                    }

                    Text {
                        text: root.ws-connected ? "Connected" : "Disconnected";
                        color: root.ws-connected ? #16A34A : #DC2626;
                        font-size: 14px;
                    }
                }
            }
        }

        // API Guide
        Rectangle {
            background: #FFFFFF;
            border-radius: 8px;
            border-width: 1px;
            border-color: #E6E8EC;
            min-height: 200px;
            horizontal-stretch: 1;
            vertical-stretch: 1;

            VerticalBox {
                padding: 16px;
                spacing: 12px;

                Text {
                    text: "API Guide";
                    color: #111827;
                    font-size: 16px;
                    font-weight: 600;
                }

                Text {
                    text: "Send Notification (GET):";
                    color: #6B7280;
                    font-size: 13px;
                }

                Text {
                    text: "curl \"" + root.service-addr + "/notify?notify=message&title=title&device=device\"";
                    color: #FF7A00;
                    font-size: 12px;
                    font-family: "monospace";
                    wrap: word-wrap;
                }

                Text {
                    text: "Send Notification (POST):";
                    color: #6B7280;
                    font-size: 13px;
                }

                Text {
                    text: "curl -X POST " + root.service-addr + "/notify -H \"Content-Type: application/json\" -d '{\"notify\":\"message\",\"title\":\"title\",\"device\":\"device\"}'";
                    color: #FF7A00;
                    font-size: 12px;
                    font-family: "monospace";
                    wrap: word-wrap;
                }
            }
        }
    }
}

// ========== Main Window ==========
export component AppWindow inherits Window {
    title: "Rutify Admin Console";
    preferred-width: 1200px;
    preferred-height: 800px;
    min-width: 1000px;
    min-height: 700px;
    background: #F6F7FB;

    // State Properties
    in-out property <Page> current-page: Page.Dashboard;
    in-out property <StatData> stats: {
        today-count: 0,
        total-count: 0,
        device-count: 0,
        is-running: true
    };
    in-out property <[NotifyItem]> recent-notifies: [];
    in-out property <[NotifyItem]> all-notifies: [];
    in-out property <[TokenItem]> tokens: [];
    in-out property <string> service-addr: "http://127.0.0.1:3000";
    in-out property <string> db-path: "rutify.db";
    in-out property <bool> ws-connected: false;

    // Callbacks
    callback page-changed(Page);
    callback search-notifies(string);
    callback refresh-notifies();
    callback create-token(string);
    callback delete-token(int);

    HorizontalBox {
        horizontal-stretch: 1;
        vertical-stretch: 1;
        // Sidebar
        Rectangle {
            width: 220px;
            background: #FFFFFF;
            border-width: 0px;
            vertical-stretch: 1;

            VerticalBox {
                padding: 16px;
                spacing: 8px;

                // Logo
                Rectangle {
                    height: 60px;

                    Text {
                        text: "Rutify";
                        color: #FF7A00;
                        font-size: 24px;
                        font-weight: 700;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                    }
                }

                Rectangle { height: 16px; }

                // Navigation
                NavItem {
                    text: "Dashboard";
                    selected: root.current-page == Page.Dashboard;
                    clicked => {
                        root.current-page = Page.Dashboard;
                        root.page-changed(Page.Dashboard);
                    }
                }

                NavItem {
                    text: "Notifications";
                    selected: root.current-page == Page.Notifications;
                    clicked => {
                        root.current-page = Page.Notifications;
                        root.page-changed(Page.Notifications);
                    }
                }

                NavItem {
                    text: "Tokens";
                    selected: root.current-page == Page.Tokens;
                    clicked => {
                        root.current-page = Page.Tokens;
                        root.page-changed(Page.Tokens);
                    }
                }

                NavItem {
                    text: "Settings";
                    selected: root.current-page == Page.Settings;
                    clicked => {
                        root.current-page = Page.Settings;
                        root.page-changed(Page.Settings);
                    }
                }
            }
        }

        // Main Content
        Rectangle {
            background: #F6F7FB;
            horizontal-stretch: 1;
            vertical-stretch: 1;

            if root.current-page == Page.Dashboard: DashboardPage {
                stats: root.stats;
                recent-notifies: root.recent-notifies;
                horizontal-stretch: 1;
                vertical-stretch: 1;
            }

            if root.current-page == Page.Notifications: NotificationsPage {
                notifies: root.all-notifies;
                search-changed(text) => { root.search-notifies(text); }
                refresh-clicked => { root.refresh-notifies(); }
                horizontal-stretch: 1;
                vertical-stretch: 1;
            }

            if root.current-page == Page.Tokens: TokensPage {
                tokens: root.tokens;
                create-token(usage) => { root.create-token(usage); }
                delete-token(id) => { root.delete-token(id); }
                horizontal-stretch: 1;
                vertical-stretch: 1;
            }

            if root.current-page == Page.Settings: SettingsPage {
                service-addr: root.service-addr;
                db-path: root.db-path;
                ws-connected: root.ws-connected;
                horizontal-stretch: 1;
                vertical-stretch: 1;
            }
        }
    }
}
